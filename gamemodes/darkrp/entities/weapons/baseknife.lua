AddCSLuaFile()

sound.Add({
    name = "csgo_knife.Deploy",
    channel = CHAN_WEAPON,
    volume = 0.4,
    level = 65,
    sound = "csgo_knife/knife_deploy1.ogg"
})

sound.Add({
    name = "csgo_knife.Hit",
    channel = CHAN_WEAPON,
    volume = 1.0,
    level = 65,
    sound = {"csgo_knife/knife_hit1.ogg", "csgo_knife/knife_hit2.ogg", "csgo_knife/knife_hit3.ogg", "csgo_knife/knife_hit4.ogg"}
})

sound.Add({
    name = "csgo_knife.HitWall",
    channel = CHAN_WEAPON,
    volume = 1.0,
    level = 65,
    sound = {"csgo_knife/knife_hit_01.ogg", "csgo_knife/knife_hit_02.ogg", "csgo_knife/knife_hit_03.ogg", "csgo_knife/knife_hit_04.ogg", "csgo_knife/knife_hit_05.ogg"}
})

sound.Add({
    name = "csgo_knife.Slash",
    channel = CHAN_WEAPON,
    volume = {0.5, 1.0},
    pitch = {97, 105},
    level = 65,
    sound = {"csgo_knife/knife_slash1.ogg", "csgo_knife/knife_slash2.ogg"}
})

sound.Add({
    name = "csgo_knife.Stab",
    channel = CHAN_WEAPON,
    volume = 1.0,
    level = 65,
    sound = "csgo_knife/knife_stab.ogg"
})

sound.Add({
    name = "csgo_ButterflyKnife.backstab01",
    channel = CHAN_ITEM,
    volume = 0.4,
    soundlevel = 65,
    sound = "csgo_knife/bknife_backstab01.ogg"
})

sound.Add({
    name = "csgo_ButterflyKnife.backstab02",
    channel = CHAN_ITEM,
    volume = 0.4,
    soundlevel = 65,
    sound = "csgo_knife/bknife_backstab02.ogg"
})

sound.Add({
    name = "csgo_ButterflyKnife.draw01",
    channel = CHAN_ITEM,
    volume = 0.6,
    soundlevel = 65,
    sound = "csgo_knife/bknife_draw01.ogg"
})

sound.Add({
    name = "csgo_ButterflyKnife.draw02",
    channel = CHAN_ITEM,
    volume = 0.6,
    soundlevel = 65,
    sound = "csgo_knife/bknife_draw02.ogg"
})

sound.Add({
    name = "csgo_ButterflyKnife.look01_a",
    channel = CHAN_ITEM,
    volume = 0.4,
    soundlevel = 65,
    sound = "csgo_knife/bknife_look01_a.ogg"
})

sound.Add({
    name = "csgo_ButterflyKnife.look01_b",
    channel = CHAN_ITEM,
    volume = 0.4,
    soundlevel = 65,
    sound = "csgo_knife/bknife_look01_b.ogg"
})

sound.Add({
    name = "csgo_ButterflyKnife.look02_a",
    channel = CHAN_ITEM,
    volume = 0.4,
    soundlevel = 65,
    sound = "csgo_knife/bknife_look02_a.ogg"
})

sound.Add({
    name = "csgo_ButterflyKnife.look02_b",
    channel = CHAN_ITEM,
    volume = 0.4,
    soundlevel = 65,
    sound = "csgo_knife/bknife_look02_b.ogg"
})

sound.Add({
    name = "csgo_ButterflyKnife.look03_a",
    channel = CHAN_ITEM,
    volume = 0.4,
    soundlevel = 65,
    sound = "csgo_knife/bknife_look03_a.ogg"
})

sound.Add({
    name = "csgo_ButterflyKnife.look03_b",
    channel = CHAN_ITEM,
    volume = 0.4,
    soundlevel = 65,
    sound = "csgo_knife/bknife_look03_b.ogg"
})

sound.Add({
    name = "csgo_KnifeFalchion.inspect",
    channel = CHAN_STATIC,
    volume = 1,
    soundlevel = 65,
    sound = "csgo_knife/knife_falchion_inspect.ogg"
})

sound.Add({
    name = "csgo_KnifeFalchion.draw",
    channel = CHAN_STATIC,
    volume = {0.4, 0.9},
    pitch = {97, 105},
    soundlevel = 65,
    sound = "csgo_knife/knife_falchion_draw.ogg"
})

sound.Add({
    name = "csgo_KnifeFalchion.Catch",
    channel = CHAN_STATIC,
    volume = {0.3, 0.7},
    pitch = {97, 105},
    soundlevel = 65,
    sound = "csgo_knife/knife_falchion_catch.ogg"
})

sound.Add({
    name = "csgo_KnifeFalchion.Idlev2",
    channel = CHAN_STATIC,
    volume = 1,
    soundlevel = 65,
    sound = "csgo_knife/knife_falchion_idle.ogg"
})

sound.Add({
    name = "csgo_Weapon.WeaponMove1",
    channel = CHAN_ITEM,
    volume = 0.15,
    soundlevel = 65,
    sound = "csgo_knife/movement1.ogg"
})

sound.Add({
    name = "csgo_Weapon.WeaponMove3",
    channel = CHAN_ITEM,
    volume = 0.15,
    soundlevel = 65,
    sound = "csgo_knife/movement3.ogg"
})

sound.Add({
    name = "csgo_Weapon.WeaponMove2",
    channel = CHAN_ITEM,
    volume = 0.15,
    soundlevel = 65,
    sound = "csgo_knife/movement2.ogg"
})

sound.Add({
    name = "csgo_KnifePush.Attack1Heavy",
    channel = CHAN_STATIC,
    volume = {0.1, 0.2},
    pitch = {98, 105},
    level = 65,
    sound = {"csgo_knife/knife_push_attack1_heavy_01.ogg", "csgo_knife/knife_push_attack1_heavy_02.ogg", "csgo_knife/knife_push_attack1_heavy_03.ogg", "csgo_knife/knife_push_attack1_heavy_04.ogg"}
})

sound.Add({
    name = "csgo_KnifePush.LookAtStart",
    channel = CHAN_STATIC,
    volume = 0.2,
    level = 65,
    sound = {"csgo_knife/knife_push_lookat_start.ogg"}
})

sound.Add({
    name = "csgo_KnifePush.LookAtEnd",
    channel = CHAN_STATIC,
    volume = 0.2,
    level = 65,
    sound = {"csgo_knife/knife_push_lookat_end.ogg"}
})

sound.Add({
    name = "csgo_KnifePush.Draw",
    channel = CHAN_STATIC,
    volume = 0.3,
    level = 65,
    sound = {"csgo_knife/knife_push_draw.ogg"}
})

sound.Add({
    name = "KnifeBowie.draw",
    channel = CHAN_STATIC,
    volume = {0.7, 0.8},
    pitch = {99, 100},
    level = 65,
    sound = {"csgo_knife/knife_bowie_draw.ogg"}
})

sound.Add({
    name = "KnifeBowie.LookAtStart",
    channel = CHAN_STATIC,
    volume = {0.2, 0.2},
    pitch = {99, 100},
    level = 65,
    sound = {"csgo_knife/knife_bowie_inspect_start.ogg"}
})

sound.Add({
    name = "KnifeBowie.LookAtEnd",
    channel = CHAN_STATIC,
    volume = {0.2, 0.3},
    pitch = {99, 101},
    level = 65,
    sound = {"csgo_knife/knife_bowie_inspect_end.ogg"}
})

if CLIENT then
    SWEP.PrintName = "baseknife"
    SWEP.DrawAmmo = false
    SWEP.DrawCrosshair = true
    SWEP.ViewModelFOV = 65
    SWEP.ViewModelFlip = false
    SWEP.CSMuzzleFlashes = true
    SWEP.UseHands = true
end

SWEP.Category = "SUP Knives"
SWEP.Spawnable = false
SWEP.AdminSpawnable = false
SWEP.DrawWeaponInfoBox = false
SWEP.Weight = 5
SWEP.AutoSwitchTo = false
SWEP.AutoSwitchFrom = false
SWEP.Primary.ClipSize = -1
SWEP.Primary.Damage = -1
SWEP.Primary.DefaultClip = -1
SWEP.Primary.Automatic = true
SWEP.Primary.Ammo = "none"
SWEP.Secondary.ClipSize = -1
SWEP.Secondary.DefaultClip = -1
SWEP.Secondary.Damage = -1
SWEP.Secondary.Automatic = true
SWEP.Secondary.Ammo = "none"

function SWEP:SetupDataTables()
    self:NetworkVar("Float", 0, "InspectTime")
    self:NetworkVar("Float", 1, "IdleTime")
end

function SWEP:Initialize()
    self:SetMaterial(self.Skin)
    self:SetHoldType(self.AreDaggers and "fist" or "knife")
end

function SWEP:Think()
    local a = self:GetOwner()
    a:GetViewModel():SetSkin(self.SkinIndex or 0)

    if CurTime() >= self:GetIdleTime() then
        self:SendWeaponAnim(ACT_VM_IDLE)
        self:SetIdleTime(CurTime() + a:GetViewModel():SequenceDuration())
    end
end

function SWEP:Deploy()
    self:SetInspectTime(0)
    self:SetIdleTime(CurTime() + self:GetOwner():GetViewModel():SequenceDuration())
    self:SendWeaponAnim(ACT_VM_DRAW)
    local b = 1
    self:SetNextPrimaryFire(CurTime() + b)
    self:SetNextSecondaryFire(CurTime() + b)

    return true
end

function SWEP:EntityFaceBack(c)
    local d = self:GetOwner():GetAngles().y - c:GetAngles().y

    if d < -180 then
        d = 360 + d
    end

    if d <= 90 and d >= -90 then return true end

    return false
end

function SWEP:PrimaryAttack()
    if CurTime() < self:GetNextPrimaryFire() then return end
    self:DoAttack(false)
end

function SWEP:SecondaryAttack()
    if CurTime() < self:GetNextSecondaryFire() then return end
    self:DoAttack(true)
end

function SWEP:DoAttack(e)
    local f = self:GetOwner()
    local g = e and 48 or 64
    local h = f:GetAimVector()
    local i = f:EyePos()
    local j = i + h * g
    local k
    local l
    local m
    local n
    f:LagCompensation(true)
    local o = {}
    o.start = i
    o.endpos = j
    o.filter = f
    o.mask = MASK_SOLID
    o.mins = Vector(-16, -16, -18)
    o.maxs = Vector(16, 16, 18)
    local p = util.TraceLine(o)
    local q = util.TraceHull(o)
    local r = IsValid(q.Entity) and q or p
    f:LagCompensation(false)
    local s = r.Hit and not r.HitSky
    local t = r.Entity
    local u = t and (t:IsPlayer() or t:IsNPC()) and IsValid(t)

    if s then
        if t and IsValid(t) then
            m = u and self:EntityFaceBack(t)
            n = e and (m and 100 or 50) or m and 75 or math.random(0, 5) == 3 and 40 or 25

            if self.Primary.Damage > 0 then
                n = self.Primary.Damage
            end

            local v = DamageInfo()
            v:SetAttacker(f)
            v:SetInflictor(self)
            v:SetDamage(n)
            v:SetDamageType(bit.bor(DMG_BULLET, DMG_NEVERGIB))
            v:SetDamageForce(h * 1000)
            v:SetDamagePosition(j)
            t:DispatchTraceAttack(v, r, h)
        else
            util.Decal("ManhackCut", r.HitPos + r.HitNormal, r.HitPos - r.HitNormal)
        end
    end

    local b = e and 1.0 or s and 0.5 or 0.4
    self:SetNextPrimaryFire(CurTime() + b)
    self:SetNextSecondaryFire(CurTime() + b)
    f:SetAnimation(PLAYER_ATTACK1)
    k = s and (e and (m and ACT_VM_SWINGHARD or ACT_VM_HITCENTER2) or (m and ACT_VM_SWINGHIT or ACT_VM_HITCENTER)) or (e and ACT_VM_MISSCENTER2 or ACT_VM_MISSCENTER)

    if k then
        self:SendWeaponAnim(k)
        self:SetIdleTime(CurTime() + f:GetViewModel():SequenceDuration())
    end

    local w = "csgo_knife.Stab"
    local x = "csgo_knife.Hit"
    local y = "csgo_knife.HitWall"
    local z = "csgo_knife.Slash"
    l = u and (e and w or x) or s and y or z

    if l then
        self:EmitSound(l)
    end

    return true
end

function SWEP:Reload()
    local A = self:GetSequence()
    local B = self:GetSequenceActivity(A)

    if B == ACT_VM_IDLE_LOWERED and CurTime() < self:GetInspectTime() then
        self:SetInspectTime(CurTime() + 0.1)

        return
    end

    self:SendWeaponAnim(ACT_VM_IDLE_LOWERED)
    self:SetIdleTime(CurTime() + self:GetOwner():GetViewModel():SequenceDuration())
    self:SetInspectTime(CurTime() + 0.1)

    return true
end