rp.orgs = rp.orgs||{}

local a = surface.DrawRect


local b=surface.SetDrawColor;local c=surface.DrawOutlinedRect;local d=surface.DrawTexturedRect;local e=surface.DrawLine;local f=math.floor;local g=input.IsMouseDown;local i=Color(150,150,150,200)local j=Color(100,100,100,200)local k=Color(0,0,0,0)local l=FindMetaTable("Color")local m=0;local n=64;local o=512/n;local p=1;local q="Square"local r=Material("sup/gui/orgs/trash.png","smooth")local s=Material("sup/gui/orgs/rename.png","smooth")local t;function rp.orgs.SaveOrgBanner(u,v)if!file.IsDir("sup","DATA")then file.CreateDir("sup")end;if!file.IsDir("sup/banners","DATA")then file.CreateDir("sup/banners")end;local v=table.Copy(v)for x=0,n-1 do for y=0,n-1 do local z=v[x][y]if z.trans then v[x][y]=-1 else v[x][y]=z.col:ToEncodedRGB()end end end;file.Write("sup/banners/"..u..".txt",util.TableToJSON(v,true))end;function rp.orgs.LoadOrgBanner(u)if t&&t:IsValid()then local v=util.JSONToTable(file.Read('sup/banners/'..u..'.txt'))local A=file.Time('sup/banners/'..u..'.txt','DATA')local B=A>1484503888&&-1||0;for x=0,n-1 do for y=0,n-1 do local C=v[x][y]if C==B then v[x][y]={trans=true}else local D=Color()D:SetEncodedRGB(C)v[x][y]={col=D}end end end;return v end end;local E,F;function rp.orgs.OpenOrgBannerEditor(G,H)if G.DrawLoading then return end;E,F=G,H;E.DrawLoading=true;net.Ping('rp.RequestOrgBannerRaw')end;net('rp.RespondOrgBannerRaw',function(I)if IsValid(E)then E.DrawLoading=false end;local J=net.ReadBool()local v;if J then v={}local n=net.ReadUInt(7)for x=0,n do v[x]={}for y=0,n do local C=net.ReadBool()&&-1||nil;if!C then C=net.ReadUInt(24)end;v[x][y]=C end end end;rp.orgs.OpenOrgBannerEditorStage2(F,v)end)local K={"^https?://.*%.jpg","^https?://.*%.png"}local function L(M)for N,O in ipairs(K)do if string.match(M,O)then return true end end end;function rp.orgs.OpenBannerImporter()local P=ui.Create('ui_frame',function(self)self:SetSize(520,120)self:SetTitle('Import Image')self:MakePopup()self:Center()self:RequestFocus()end)local Q;local R=ui.Create('DTextEntry',function(self,S)self:SetPos(5,60)self:SetSize(S:GetWide()-10,25)self:SetPlaceholderText('URL...')self.OnEnter=function(T)Q:DoClick()end end,P)ui.Create('DLabel',function(self,S)self:SetText('.jpg and .png images only! No porn, gore, ect or ban.')self:SetFont('ui.24')self:SetTextColor(ui.col.White)self:SizeToContents()self:SetPos((S:GetWide()-self:GetWide())/2,32)end,P)Q=ui.Create('ui_button',function(self,S)self:SetText('Import')self:SetPos(5,90)self:SetSize(S:GetWide()-10,25)function self:Think()if!IsValid(t)&&IsValid(S)then S:Close()end;if L(R:GetValue())then self:SetDisabled(false)else self:SetDisabled(true)end end;function self:DoClick()self:SetText('Importing...')self.Think=function()end;self:SetDisabled(true)S:ShowCloseButton(false)local U=false;timer.Simple(5,function()if IsValid(S)then S:ShowCloseButton(true)self:SetText('Import timed out...')end end)local M=string.Trim(R:GetValue())local V=texture.Create(M):SetSize(64,64):SetFormat('png'):Download(M,function(self)self:EnableCache(false)self:Render(function(self,w,h)surface.SetDrawColor(255,255,255)surface.SetMaterial(self:GetMaterial())surface.DrawTexturedRect(0,0,w,h)end,function(texture,W)if U then return end;local X={}for Y=0,n-1 do X[Y]={}for Z=0,n-1 do local D=W:GetColor(Y,Z)local _=D.a==0;X[Y][Z]=_&&{trans=_}||{col=setmetatable(D,_R.Color)}end end;if IsValid(t)then t.pnlPaintArea.pixels=X;t.pnlPaintArea.invalidated=true end;if IsValid(S)then S:Close()end end)end,function()if IsValid(S)then S:ShowCloseButton(true)end;if IsValid(self)then self:SetText('Import failed...')end end)end end,P)end;function rp.orgs.OpenOrgBannerEditorStage2(F,a0)if t&&t:IsValid()then t:Remove()end;p=1;q="Square"local a1=ui.Create('ui_frame')a1:Focus()a1.pnlPaintArea=ui.Create("Panel",a1)a1.clrCombo=ui.Create("DColorMixer",a1)a1.numCursorSize=ui.Create("DComboBox",a1)function a1.numCursorSize:OpenMenu(a2)if a2 then if a2==self.TextEntry then return end end;if#self.Choices==0 then return end;if IsValid(self.Menu)then self.Menu:Remove()self.Menu=nil end;self.Menu=ui.DermaMenu()for y,z in pairs(self.Choices)do self.Menu:AddOption(z,function()self:ChooseOption(z,y)end)end;local Y,Z=self:LocalToScreen(0,self:GetTall())self.Menu:SetMinimumWidth(self:GetWide())self.Menu:Open(Y,Z,false,self)end;a1.comboCursorShape=ui.Create("DComboBox",a1)a1.lblCursorSize=ui.Create("DLabel",a1)a1.lblCursorShape=ui.Create("DLabel",a1)a1.lblSubdivision=ui.Create("DLabel",a1)a1.btnSubdivisionUp=ui.Create("ui_button",a1)a1.btnSubdivisionDown=ui.Create("ui_button",a1)a1.pnlPreview=ui.Create("Panel",a1)a1.btnSubmit=ui.Create("ui_button",a1)a1.btnLoad=ui.Create("ui_button",a1)a1.btnSave=ui.Create("ui_button",a1)a1.btnReset=ui.Create("ui_button",a1)a1.btnImport=ui.Create("ui_button",a1)a1.iSubdivide=1;local Y,Z=a1:GetDockPos()a1.pnlPaintArea:SetPos(Y,Z)a1.pnlPaintArea:SetSize(512+m*2,512+m*2)a1:SetSize(768,Z+a1.pnlPaintArea:GetTall()+5)a1:SetTitle("Organization Flag")a1.clrCombo:SetPalette(false)a1.clrCombo:SetAlphaBar(false)a1.clrCombo:SetWangs(true)a1.clrCombo:SetPos(5+a1.pnlPaintArea:GetWide()+5,Z)a1.clrCombo:SetSize(a1:GetWide()-a1.pnlPaintArea:GetWide()-15,160)a1.clrCombo:SetColor(Color(255,255,255))local a3=(a1:GetWide()-a1.pnlPaintArea:GetWide()-20)/2;a1.lblCursorSize:SetText("Cursor Size")a1.lblCursorSize:SetPos(a1.clrCombo.x,a1.clrCombo:GetTall()+35)a1.lblCursorSize:SizeToContents()a1.numCursorSize:SetPos(a1.clrCombo.x-1,a1.lblCursorSize.y+a1.lblCursorSize:GetTall()+3)a1.numCursorSize:SetWide(a3)a1.numCursorSize:SetValue("1 px")for x=1,15 do a1.numCursorSize:AddChoice(x.." px")end;a1.numCursorSize.OnSelect=function(self,a4,a5)p=a4 end;a1.lblCursorShape:SetText("Cursor Shape")a1.lblCursorShape:SetPos(a1.numCursorSize.x+a1.numCursorSize:GetWide()+6,a1.lblCursorSize.y)a1.lblCursorShape:SizeToContents()a1.comboCursorShape:SetPos(a1.numCursorSize.x+a1.numCursorSize:GetWide()+6,a1.lblCursorSize.y+a1.lblCursorSize:GetTall()+3)a1.comboCursorShape:SetWide(a3)a1.comboCursorShape:SetValue("Square")a1.comboCursorShape:AddChoice("Square")a1.comboCursorShape:AddChoice("Circle")a1.comboCursorShape:AddChoice("Horizontal")a1.comboCursorShape:AddChoice("Vertical")a1.comboCursorShape:AddChoice("Diagonal Up")a1.comboCursorShape:AddChoice("Diagonal Down")a1.comboCursorShape:AddChoice("Outlined Square")a1.comboCursorShape:AddChoice("Eyedropper")a1.comboCursorShape.OnSelect=function(self,a4,a5)q=a5 end;a1.lblSubdivision:SetText("Guidelines")a1.lblSubdivision:SetPos(a1.clrCombo.x,a1.comboCursorShape.y+a1.comboCursorShape:GetTall()+2)a1.lblSubdivision:SizeToContents()a1.btnSubdivisionDown:SetPos(a1.lblSubdivision.x,a1.lblSubdivision.y+a1.lblSubdivision:GetTall()+3)a1.btnSubdivisionDown:SetText("-")a1.btnSubdivisionDown:SetSize(a3,15)a1.btnSubdivisionDown.DoClick=function(self)self:GetParent().iSubdivide=math.Clamp(self:GetParent().iSubdivide-1,1,10)end;a1.btnSubdivisionUp:SetPos(a1.lblSubdivision.x+a3+5,a1.lblSubdivision.y+a1.lblSubdivision:GetTall()+3)a1.btnSubdivisionUp:SetText("+")a1.btnSubdivisionUp:SetSize(a3,15)a1.btnSubdivisionUp.DoClick=function(self)self:GetParent().iSubdivide=math.Clamp(self:GetParent().iSubdivide+1,1,10)end;a1.pnlPreview:SetPos(a1.clrCombo.x,a1.btnSubdivisionDown.y+a1.btnSubdivisionDown:GetTall()+5)a1.pnlPreview:SetSize(94,94)a1.btnSubmit:SetFont("ui.22")a1.btnSubmit:SetText("Submit")a1.btnSubmit:SetPos(a1.clrCombo.x,a1:GetTall()-50)a1.btnSubmit:SetSize(a3*2+5,45)if!F.Owner&&!F.Banner then a1.btnSubmit:SetDisabled(true)end;local a6;if!F.Banner then a6="Your rank cannot edit this Organization's flag!"else a6="Your Organization's flag can be used in picture frames as well as our website!"end;local a7=string.Wrap(a6,'ui.22',a1.btnSubmit:GetWide())local a8=a1.pnlPreview.y+a1.pnlPreview:GetTall()+(a1.btnSubmit.x-(a1.pnlPreview.y+a1.pnlPreview:GetTall())-#a7*22)/2;for y,z in ipairs(a7)do local a9=ui.Create('DLabel')a9:SetParent(a1)a9:SetFont('ui.22')a9:SetText(z)a9:SizeToContents()a9:SetPos(a1.btnSubmit.x+(a1.btnSubmit:GetWide()-a9:GetWide())/2,a8)a8=a8+22 end;a1.btnLoad:SetText("Load..")a1.btnLoad:SetFont("ui.22")a1.btnLoad:SetPos(a1.pnlPreview.x+a1.pnlPreview:GetWide()+5,a1.pnlPreview.y)a1.btnLoad:SetSize(a3*2-a1.pnlPreview:GetWide(),math.floor((a1.pnlPreview:GetTall()-10)/3))a1.btnLoad.DoClick=function(self)local aa,N=file.Find("sup/banners/*.txt","DATA")if#aa==0 then local ab=ui.DermaMenu()ab:AddOption("No designs saved yet",function()end)ab:Open()ab:SetPos(a1.x+a1:GetWide(),a1.y+a1.btnLoad.y)return end;local ac=false;local ad=GetRenderTarget("SUPLoadBannerPreview",512,512,true)local ae=CreateMaterial("SUPLoadBannerPreview","UnlitGeneric",{["$ignorez"]=1,["$vertexcolor"]=1,["$vertexalpha"]=1,["$nolod"]=1,["$basetexture"]=ad:GetName()})a1.over_loadPreview=ui.Create('Panel',function(af)af:SetPos(a1.pnlPaintArea:GetPos())af:SetSize(a1.pnlPaintArea:GetSize())af.Paint=function(self,w,h)if!ac then return false end;if IsValid(self.current)then local ag,ah=self.current:CursorPos()if!(ag>=0&&ah>=0&&ag<=self.current:GetWide()&&ah<=self.current:GetTall())then return false end end;surface.SetMaterial(ae)b(255,255,255,255)surface.DrawTexturedRect(1,1,w-2,h-2)end end,a1)a1.over_loadList=ui.Create('Panel',function(af)local N,Z=a1:GetDockPos()af:SetPos(a1.over_loadPreview:GetWide()+9,Z)af:SetSize(a1:GetWide()-af.x-5,a1:GetTall()-Z-55)af.Paint=function(T,w,h)b(0,0,0,255)a(0,0,w,h)b(ui.col.Outline)c(0,0,w,h)end;af.scroll=ui.Create("ui_scrollpanel",function(T)T:SetPos(0,0)T:SetSize(af:GetWide(),af:GetTall())end,af)for y,z in ipairs(aa)do local ai=ui.Create("ui_button")ai:SetText("")ai:SetTall(40)local u=string.sub(z,1,-5)local aj=ui.Create("DLabel",ai)aj:SetText(u)aj:SizeToContents()aj:SetPos(5,20-aj:GetTall()*0.5)local ak=ui.Create("ui_button",ai)ak:SetText("")ak:SetSize(40,40)ak:Dock(RIGHT)ak.PaintOver=function(T)surface.SetMaterial(r)if T.Clicked then b(255,50,50)else b(255,255,255)end;d(8,8,24,24)end;ak.DoClick=function(T)if T.Clicked then file.Delete("sup/banners/"..z)ai:Remove()af.scroll:PerformLayout()else T.Clicked=true;timer.Simple(2,function()if IsValid(T)then T.Clicked=false end end)end end;local al=ui.Create("ui_button",ai)al:SetText("")al:SetSize(40,40)al:Dock(RIGHT)al.PaintOver=function(T)surface.SetMaterial(s)b(255,255,255)d(8,8,24,24)end;al.DoClick=function(T,a6)local a6=a6||"What would you like to name this design?"ui.StringRequest("Rename Design",a6,u,function(a5)if u:lower()==a5:lower()then return end;for y,z in ipairs(aa)do if z:lower()==a5:lower()..".txt"then T:DoClick("You already have a design with that name. Please enter another.")return end end;file.Rename("sup/banners/"..z,"sup/banners/"..a5 ..".txt")u=a5;aj:SetText(a5)aj:SizeToContents()end)end;af.scroll:AddItem(ai)ai.Think=function(T)local ag,ah=T:CursorPos()if ag>=0&&ah>=0&&ag<=T:GetWide()&&ah<=T:GetTall()then if a1.over_loadPreview.current!=T then a1.over_loadPreview.current=T;ai.pixels=rp.orgs.LoadOrgBanner(u)a1.pnlPaintArea:RenderBanner(a1.over_loadPreview:GetWide(),a1.over_loadPreview:GetTall(),ad,ai.pixels)ac=true end end end;ai.DoClick=function(T)if!ai.pixels then return end;a1.pnlPaintArea.pixels=ai.pixels;a1.pnlPaintArea.invalidated=true;a1.over_btnCancel:DoClick()end end end,a1)a1.over_btnCancel=ui.Create("ui_button",a1)a1.over_btnCancel:SetPos(a1.btnSubmit.x,a1.btnSubmit.y)a1.over_btnCancel:SetSize(a1.btnSubmit:GetSize())a1.over_btnCancel:SetText("Cancel")a1.over_btnCancel.DoClick=function()a1.over_loadList:Remove()a1.over_loadPreview:Remove()a1.over_btnCancel:Remove()a1.btnSubmit:SetVisible(true)end;a1.btnSubmit:SetVisible(false)end;a1.btnSave:SetText("Save..")a1.btnSave:SetFont("ui.22")a1.btnSave:SetPos(a1.pnlPreview.x+a1.pnlPreview:GetWide()+5,a1.btnLoad.y+a1.btnLoad:GetTall()+5)a1.btnSave:SetSize(a1.btnLoad:GetWide(),a1.btnLoad:GetTall())a1.btnSave.DoClick=function(self)local aa,am=file.Find("sup/banners/*.txt","DATA")local ab=ui.DermaMenu()ab:AddOption("New..",function()local function an(ao)ui.StringRequest("New Design",(ao&&"That save already exists.\n\n"||"").."Please enter a name for your design.","Untitled 1",function(ap)if file.Exists("sup/banners/"..ap..".txt","DATA")then an(true)return end;rp.orgs.SaveOrgBanner(ap,t.pnlPaintArea.pixels)end)end;an()end)for y,z in pairs(aa)do ab:AddOption(string.sub(z,1,-5),function()rp.orgs.SaveOrgBanner(string.sub(z,1,-5),t.pnlPaintArea.pixels)end)end;ab:Open()ab:SetPos(a1.x+a1:GetWide(),a1.y+a1.btnSave.y)end;a1.btnReset:SetText("Reset Canvas")a1.btnReset:SetFont("ui.22")a1.btnReset:SetPos(a1.pnlPreview.x+a1.pnlPreview:GetWide()+5,a1.btnSave.y+a1.btnSave:GetTall()+5)a1.btnReset:SetSize(a1.btnLoad:GetWide(),a1.btnLoad:GetTall())a1.btnReset.DoClick=function(self)self:GetParent().pnlPaintArea:Reset(true)end;a1.btnImport:SetText("URL Import")a1.btnImport:SetFont("ui.22")a1.btnImport:SetPos(a1.pnlPreview.x+a1.pnlPreview:GetWide()+5,a1.pnlPreview.y+a1.pnlPreview:GetTall()+5)a1.btnImport:SetSize(a3*2-a1.pnlPreview:GetWide(),math.floor((a1.pnlPreview:GetTall()-10)/3))a1.btnImport.DoClick=rp.orgs.OpenBannerImporter;a1.pnlPaintArea.cursors={}a1.pnlPaintArea.Reset=function(self,aq)if aq||!a0 then self.pixels={}else self.pixels=table.Copy(a0)for y=0,n-1 do for x=0,n-1 do if self.pixels[y][x]==-1 then self.pixels[y][x]={trans=true}else local D=Color()D:SetEncodedRGB(self.pixels[y][x])self.pixels[y][x]={col=D}end end end end;if!self.pixels[1]then for Y=1,n do self.pixels[Y-1]={}for Z=1,n do self.pixels[Y-1][Z-1]={col=i,trans=true}end end end;self:RenderBanner(w,h)end;a1.SendImage=function(self)self.btnSubmit:SetMouseInputEnabled(false)self.btnSubmit:SetText("Sending..")net("rp.OrgBannerReceived",function(I)if self:IsValid()&&self.btnSubmit:IsValid()then self.btnSubmit:SetMouseInputEnabled(true)self.btnSubmit:SetText("Submit")end end)net.Start('rp.SetOrgBanner')net.WriteUInt(n-1,7)for x=0,n-1 do for y=0,n-1 do local C=self.pnlPaintArea.pixels[x][y]net.WriteBool(C.trans)if!C.trans then net.WriteUInt(setmetatable(C.col,_R.Color):ToEncodedRGB(),24)end end end;net.SendToServer()end;a1.btnSubmit.DoClick=function(self)self:GetParent():SendImage()cvar.SetValue('OrgBanner',self:GetParent().pnlPaintArea.pixels)end;local ar=GetRenderTarget("SUPBannerPreview2",512,512,true)local as=CreateMaterial("SUPBannerPreview2","UnlitGeneric",{["$ignorez"]=1,["$vertexcolor"]=1,["$vertexalpha"]=1,["$nolod"]=1,["$basetexture"]=ar:GetName()})a1.pnlPaintArea.Paint=function(self,w,h)if self.invalidated then self:RenderBanner(w,h)self.invalidated=false end;surface.SetMaterial(as)b(255,255,255,255)surface.DrawTexturedRect(1,1,w-2,h-2)end;a1.pnlPaintArea.RenderBanner=function(self,w,h,at,au)at=at||ar;au=au||self.pixels;local av=render.GetRenderTarget()local aw=ScrW()local ax=ScrH()render.SetRenderTarget(at)render.Clear(0,0,0,0)render.ClearDepth()render.SetViewPort(0,0,512,512)cam.Start2D()for Y,z in pairs(au)do for Z,v in pairs(z)do local ay=Y*o;local az=Z*o;if!v.trans then b(v.col)a(ay,az,o,o)else local aA=i;local aB=j;local aC=o/2;b(aA)a(ay,az,aC,aC)a(ay+aC,az+aC,aC,aC)b(aB)a(ay+aC,az,aC,aC)a(ay,az+aC,aC,aC)end end end;cam.End2D()render.SetViewPort(0,0,aw,ax)render.SetRenderTarget(av)end;a1.pnlPaintArea.cursors["Square"]=function(self,Y,Z)local aD={}local aE=f(p/2)local aF=0;if aE<1 then aE=0 end;if p==2 then aE=0;aF=o/2 end;local ay=f((Y-m-aF)/o)-aE;local az=f((Z-m-aF)/o)-aE;for Y=0,p-1 do if self.pixels[ay+Y]&&self.pixels[ay+Y][az]then table.insert(aD,{ay+Y,az})end;for Z=0,p-1 do if self.pixels[ay+Y]&&self.pixels[ay+Y][az+Z]then table.insert(aD,{ay+Y,az+Z})end end end;return aD end;a1.pnlPaintArea.cursors["Circle"]=function(self,Y,Z)local aD={}local ay=f((Y-m)/o)local az=f((Z-m)/o)local aG=ay-f(p/2)local aH=az-f(p/2)for Y=aG,aG+p do for Z=aH,aH+p do if self.pixels[Y]&&self.pixels[Y][Z]then if(Y-ay)^2+(Z-az)^2<=(p/2)^2 then table.insert(aD,{Y,Z})end end end end;return aD end;a1.pnlPaintArea.cursors["Horizontal"]=function(self,Y,Z)local aD={}local aE=f(p/2)local aF=0;if aE<1 then aE=0 end;if p==2 then aE=0;aF=o/2 end;local ay=f((Y-m-aF)/o)-aE;local az=f((Z-m-aF)/o)for Y=0,p-1 do if self.pixels[ay+Y]&&self.pixels[ay+Y][az]then table.insert(aD,{ay+Y,az})end end;return aD end;a1.pnlPaintArea.cursors["Vertical"]=function(self,Y,Z)local aD={}local aE=f(p/2)local aF=0;if aE<1 then aE=0 end;if p==2 then aE=0;aF=o/2 end;local ay=f((Y-m-aF)/o)local az=f((Z-m-aF)/o)-aE;for Z=0,p-1 do if self.pixels[ay]&&self.pixels[ay][az+Z]then table.insert(aD,{ay,az+Z})end end;return aD end;a1.pnlPaintArea.cursors["Diagonal Down"]=function(self,Y,Z)local aD={}local aE=f(p/2)local aF=0;if aE<1 then aE=0 end;if p==2 then aE=0;aF=o/2 end;local ay=f((Y-m-aF)/o)-aE;local az=f((Z-m-aF)/o)-aE;for x=0,p-1 do if self.pixels[ay+x]&&self.pixels[ay+x][az+x]then table.insert(aD,{ay+x,az+x})end end;return aD end;a1.pnlPaintArea.cursors["Diagonal Up"]=function(self,Y,Z)local aD={}local aE=f(p/2)local aF=0;if aE<1 then aE=0 end;if p==2 then aE=0;aF=o/2 end;local ay=f((Y-m-aF)/o)-aE;local az=f((Z-m-aF)/o)+aE;for x=0,p-1 do if self.pixels[ay+x]&&self.pixels[ay+x][az-x]then table.insert(aD,{ay+x,az-x})end end;return aD end;a1.pnlPaintArea.cursors["Outlined Square"]=function(self,Y,Z)local aD={}local aE=f(p/2)local aF=0;if aE<1 then aE=0 end;if p==2 then aE=0;aF=o/2 end;local ay=f((Y-m-aF)/o)-aE;local az=f((Z-m-aF)/o)-aE;for Y=0,p-1 do if self.pixels[ay+Y]&&self.pixels[ay+Y][az]then table.insert(aD,{ay+Y,az})end;if self.pixels[ay+Y]&&self.pixels[ay+Y][az+p-1]then table.insert(aD,{ay+Y,az+p-1})end end;for Z=0,p-1 do if self.pixels[ay]&&self.pixels[ay][az+Z]then table.insert(aD,{ay,az+Z})end;if self.pixels[ay+p-1]&&self.pixels[ay+p-1][az+Z]then table.insert(aD,{ay+p-1,az+Z})end end;return aD end;a1.pnlPaintArea.cursors["Eyedropper"]=function(self,Y,Z)local aD={}local p=1;local ay=f((Y-m)/o)local az=f((Z-m)/o)do if self.pixels[ay]&&self.pixels[ay][az]then table.insert(aD,{ay,az})end;do if self.pixels[ay]&&self.pixels[ay][az]then table.insert(aD,{ay,az})end end end;return aD end;a1.pnlPaintArea.GetActivePixels=function(self)local Y,Z=self:CursorPos()if Y<m||Y>=512+m||(Z<m||Z>=512+m)then return{}end;return self.cursors[q](self,Y,Z)end;a1.pnlPaintArea.PaintOver=function(self,w,h)for y,z in pairs(self:GetActivePixels())do local Y=z[1]*o+m;local Z=z[2]*o+m;local C=self.pixels[z[1]][z[2]]if C.trans then b(255,50,50)else local aI=C.col;local Z=(299*aI.r+587*aI.g+1144*aI.b)/1000;if Z>=128 then b(0,0,0)else b(255,255,255)end end;c(Y,Z,o,o)end;b(ui.col.Outline)c(0,0,w,h)local aJ=self:GetParent().iSubdivide;if aJ>1 then b(50,50,50)for x=1,aJ-1 do e(x*w/aJ,0,x*w/aJ,h)e(0,x*h/aJ,w,x*h/aJ)end end end;a1.pnlPaintArea.OnMousePressed=function(self,aK)if aK==MOUSE_LEFT then self.isClicked=true end;if aK==MOUSE_RIGHT then self.isRightClicked=true end end;a1.pnlPaintArea.OnMouseReleased=function(self,aK)if aK==MOUSE_LEFT then self.isClicked=false end;if aK==MOUSE_RIGHT then self.isRightClicked=false end end;a1.pnlPaintArea.OnCursorEntered=function(self)if!system.IsOSX()then self:SetCursor("blank")end end;a1.pnlPaintArea.OnCursorExited=function(self)if!system.IsOSX()then self:SetCursor("arrow")end end;a1.pnlPaintArea.Think=function(self)if!self.isClicked&&!self.isRightClicked then return end;local Y,Z=self:CursorPos()if Y<m||Y>=512+m||(Z<m||Z>=512+m)then if self.isClicked&&!g(MOUSE_LEFT)then self.isClicked=false end;if self.isRightClicked&&!g(MOUSE_RIGHT)then self.isRightClicked=false end end;local aL=false;local aM=self:GetParent().clrCombo:GetColor()if q=="Eyedropper"then local aN=self:GetActivePixels()[1]local C=self.pixels[aN[1]][aN[2]]if C.trans then return end;self:GetParent().clrCombo:SetColor(C.col)else for y,z in pairs(self:GetActivePixels())do local C=self.pixels[z[1]][z[2]]if self.isClicked then if!C.col||C.col.r!=aM.r||C.col.g!=aM.g||C.col.b!=aM.b||C.trans then C.col=setmetatable(table.Copy(aM),l)C.trans=false;aL=true end elseif self.isRightClicked then if!C.trans then C.trans=true;aL=true end end end end;if aL then self.invalidated=true end end;a1.pnlPreview.Paint=function(self,w,h)surface.SetMaterial(as)b(255,255,255)surface.DrawTexturedRect(0,0,w,h)end;a1:Center()a1:SetVisible(true)a1:MakePopup()a1.pnlPaintArea:Reset()t=a1 end